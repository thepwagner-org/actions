name: Build
on:
  workflow_call:
    inputs:
      committer:
        required: false
        type: string
        description: The committer name
        default: "wapwagner" # wapwagner number one
      committer_email:
        required: false
        type: string
        description: The committer email
        default: "70587923+wapwagner@users.noreply.github.com"
    secrets:
      not_github_token:
        required: true
        description: A non-Actions GitHub token, so Actions will react to pushes.

permissions:
  contents: write 
  actions: write
  pull-requests: write
  
env:
  DOCKER_BUILDKIT: 1

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: "ðŸŒŽ Fetching code"
        uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b # tag=v3.0.2
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: "ðŸŒŽ Logging in to Docker Registry"
        uses: docker/login-action@49ed152c8eca782a232dede0303416e8f356c37b # tag=v2.0.0
        with:
          registry: ghcr.io
          username: ${{github.repository_owner}}
          password: ${{secrets.not_github_token}}

      - name: "ðŸš§ Building image"
        run: docker build --secret id=git-credentials,env=GITHUB_TOKEN -t ghcr.io/${{github.repository}}:${{github.sha}} .
        env:
          GITHUB_TOKEN: ${{secrets.not_github_token}}

      - name: "ðŸ“· Setup Syft"
        uses: anchore/sbom-action/download-syft@bb716408e75840bbb01e839347cd213767269d4a # tag=v0.11.0
      - name: "ðŸ“¸ Generate SBOM"
        run: syft packages -o cyclonedx-json=sbom.cyclonedx.json ghcr.io/${{github.repository}}:${{github.sha}}

      - name: "ðŸ•µï¸ Verify SBOM"
        id: verify
        run: |
          BUILT_PACKAGES=$(jq -r '.components[].purl' sbom.cyclonedx.json | grep -v ^null | sort)
          if [[ -f go.mod ]]; then
            OWN_MODULE=$(grep ^module go.mod | cut -d' ' -f2)
            BUILT_PACKAGES=$(echo -e "$BUILT_PACKAGES" | grep -v "$OWN_MODULE")
          fi
          echo "Built packages:"
          echo "$BUILT_PACKAGES" | tee built.txt
          echo ""
          echo ""
          echo ""

          STORED_PACKAGES=$(jq -r '.components[].purl' Dockerfile.cyclonedx.json | grep -v ^null | sort)
          if [[ -f go.mod ]]; then
            OWN_MODULE=$(grep ^module go.mod | cut -d' ' -f2)
            STORED_PACKAGES=$(echo -e "$STORED_PACKAGES" | grep -v "$OWN_MODULE")
          fi
          echo "Stored packages:"
          echo "$STORED_PACKAGES" | tee stored.txt

          # Exit if packages match the committed SBOM
          (diff -b -U 0 stored.txt built.txt || true) > pkgdiff.txt
          if [[ ! -s pkgdiff.txt ]]; then
            exit 0
          fi

          # On mismatch, commit and push the updated SBOM:
          git reset origin/${GITHUB_HEAD_REF}
          mv sbom.cyclonedx.json Dockerfile.cyclonedx.json
          git config user.name "${{inputs.committer}}"
          git config user.email "${{inputs.committer_email}}"
          git add Dockerfile.cyclonedx.json
          git commit -m'generated SBOM'
          git push "https://${{inputs.committer}}:${{secrets.not_github_token}}@github.com/${GITHUB_REPOSITORY}.git" HEAD:${GITHUB_HEAD_REF}
          exit 1
      - name: "ðŸ”Š Comment on PR"
        uses: actions/github-script@9ac08808f993958e9de277fe43a64532a609130e # tag=v6.0.0
        if: ${{ failure() && steps.verify.outcome == 'failure'}}
        with:
          script: |
            const fs = require('fs');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '```\n' + fs.readFileSync('pkgdiff.txt') + '\n```',
            });
